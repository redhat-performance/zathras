name: Test GCP

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      gcp_region:
        description: 'GCP region for testing'
        required: false
        default: 'us-central1'
      gcp_zone:
        description: 'GCP zone for testing'
        required: false
        default: 'us-central1-a'
      machine_type:
        description: 'GCP machine type (leave empty for default n2-standard-4)'
        required: false
      image_family:
        description: 'GCP image family (leave empty for default RHEL 9)'
        required: false

  # Automatic trigger on PR to main
  pull_request:
    branches:
      - main
    paths:
      - 'bin/**'
      - 'ansible_roles/**'
      - 'config/**'
      - 'ci/test_scenarios/gcp_ci_test.yml'
      - '.github/workflows/test-gcp.yml'
      - '.github/actions/**'

# Permissions required for OIDC authentication to GCP
permissions:
  id-token: write  # Required for requesting JWT
  contents: read   # Required for actions/checkout
  pull-requests: write  # Required for commenting on PRs

env:
  GCP_REGION: ${{ inputs.gcp_region || 'us-central1' }}
  GCP_ZONE: ${{ inputs.gcp_zone || 'us-central1-a' }}
  SCENARIO_FILE: ci/test_scenarios/gcp_ci_test.yml

jobs:
  test-gcp:
    name: Test on GCP
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Prevent runaway costs

    steps:
      - name: Authenticate to Google Cloud via OIDC
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify GCP authentication
        run: |
          echo "Verifying GCP credentials..."
          gcloud auth list
          gcloud config list
          echo "GCP CLI configured successfully"

      - name: Set GCP project
        run: |
          # Extract project from service account or use secret
          if [ -n "${{ secrets.GCP_PROJECT_ID }}" ]; then
            gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          fi
          echo "Active project: $(gcloud config get-value project)"

      - name: Set up Zathras
        uses: ./.github/actions/setup-zathras
        with:
          ssh-private-key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}

      - name: Determine GCP image
        id: image
        run: |
          # Use provided image family or default to RHEL 9
          if [ -n "${{ inputs.image_family }}" ]; then
            IMAGE_FAMILY="${{ inputs.image_family }}"
          else
            IMAGE_FAMILY="rhel-9"
          fi

          # Construct full image path
          IMAGE_ID="projects/rhel-cloud/global/images/family/${IMAGE_FAMILY}"
          echo "Using image: $IMAGE_ID"
          echo "image_id=$IMAGE_ID" >> $GITHUB_OUTPUT

      - name: Run Zathras test on GCP
        id: test
        uses: ./.github/actions/run-zathras-test
        with:
          scenario-file: ${{ env.SCENARIO_FILE }}
          cloud-os-id: ${{ steps.image.outputs.image_id }}
          additional-args: ${{ inputs.machine_type && format('--host_config {0}', inputs.machine_type) || '' }}

      - name: Check for orphaned resources
        if: always()
        run: |
          echo "Checking for orphaned GCE instances..."
          PROJECT=$(gcloud config get-value project)
          gcloud compute instances list \
            --filter="labels.managed_by=zathras" \
            --format="table(name,zone,status,creationTimestamp)" || true

      - name: Post results to PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.test.outputs.test-status }}';
            const emoji = status === 'success' ? '✅' : '❌';
            const body = `## ${emoji} GCP Test Results

            **Status:** ${status}
            **Region/Zone:** ${{ env.GCP_REGION }}/${{ env.GCP_ZONE }}
            **Image:** ${{ steps.image.outputs.image_id }}
            **Workflow:** [Run #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ${status === 'success' ? 'All tests passed successfully!' : 'Tests failed. Check workflow logs for details.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail workflow if tests failed
        if: steps.test.outputs.test-status != 'success'
        run: |
          echo "❌ GCP tests failed"
          exit 1
